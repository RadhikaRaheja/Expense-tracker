<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" />

<title>Daily Expenses Tracker 🎀</title>
<style>
    :root {
        --brand: #e91e63;
        --btn: #f8bbd0;
        --btn-hover: #f48fb1;
        --card-bg: rgba(255, 255, 255, 0.88);
        --border: #ccc;
        --text: #222;
        --table-header: #fafafa;
        --neg-text: #8b0000;
        --neg-bg: #ffe5e5;
    }

    body {
        margin: 0;
        font-family: 'Quicksand', sans-serif;
        color: var(--text);
        background: url('https://i.pinimg.com/736x/58/09/12/5809128d95aee17fdad43073ef5495be.jpg') no-repeat center center fixed;
        background-size: cover;
    }

    .app {
        max-width: 900px;
        margin: 40px auto 60px;
        background: var(--card-bg);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }

    h1 {
        text-align: center;
        color: var(--brand);
        margin: 6px 0 16px;
    }

    nav {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 18px;
    }

    nav button {
        background-color: var(--btn);
        border: none;
        padding: 10px 18px;
        border-radius: 20px;
        font-weight: 700;
        cursor: pointer;
        transition: 0.2s ease;
    }

    nav button:hover {
        background-color: var(--btn-hover);
        transform: translateY(-1px);
    }

    .section {
        display: none;
    }

    .section.active {
        display: block;
    }

    .field {
        margin: 10px 0;
    }

    .field label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
    }

    input,
    select,
    textarea {
        width: 70%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-family: inherit;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th,
    td {
        padding: 10px;
        border: 1px solid var(--border);
        text-align: center;
        background: #fff;
    }

    th {
        background: var(--table-header);
    }

    .inline-input {
        border: none;
        background: transparent;
        width: 90%;
    }

    .muted {
        color: #666;
    }

    .neg {
        color: var(--neg-text);
        font-weight: 700;
    }
</style>

</head> <body>
<div class="app">

    <h1>Daily Expenses Tracker 🎀</h1>

    <!-- Navigation -->
    <nav>
        <button onclick="switchTab('add')">➕ Add</button>
        <button onclick="switchTab('view')">📊 View</button>
        <button onclick="switchTab('profit')">💰 Profit</button>
        <button onclick="switchTab('investment')">📈 Investment</button>
    </nav>

    <!-- Add Expense Tab -->
    <div id="add" class="section active">
        <div class="field">
            <label for="date">Date</label>
            <input type="date" id="date" />
        </div>

        <div class="field">
            <label for="amount">Expense Amount</label>
            <input type="number" id="amount" />
        </div>

        <div class="field">
            <label for="note">Comments</label>
            <textarea id="note"></textarea>
        </div>

        <button onclick="addTransaction()">Save</button>
        <p class="muted">Entries are saved locally and persist after refresh.</p>
    </div>

    <!-- View Expenses Tab -->
    <div id="view" class="section">
        <div class="field">
            <label for="view-month">Month & Year</label>
            <select id="view-month" onchange="fetchView()"></select>
        </div>

        <h3 id="total-expense">Total: ₹0</h3>
        <table id="view-table"></table>
    </div>

    <!-- Profit Tab -->
    <div id="profit" class="section">
        <div class="field">
            <label for="profit-month">Month & Year</label>
            <select id="profit-month" onchange="fetchProfit()"></select>
        </div>

        <h3 id="profit-display">Profit: ₹0</h3>
    </div>

    <!-- Investment Tab -->
    <div id="investment" class="section">
        <h3>Summary</h3>
        <ul id="investment-summary"></ul>

        <h3>Vendor Balances</h3>
        <table id="vendor-table"></table>

        <p class="muted">
            Color scale: negative = red. 0–4,999 uses yellow gradient (toward 5,000). ≥5,000 uses green gradient (deepest green is the highest).
        </p>
    </div>
</div>

<script>
    // =====================================================
    // CONFIGURATION
    // =====================================================
    const sheetURL = 'https://opensheet.elk.sh/1UMul8nt25GR8MUM-_EdwAR0q6Ne2ovPv_R-m1-CHeXw/';
    const summarySheetName = 'Vendor%20Sales%20Record';

    // Fixed cell mapping based on your sheet structure:
    // J2 = Available Wallet, J3 = Reseller Amount Due, J4 = Client Due, J5 = Total Amount Invested
    // OpenSheet converts this to JSON where column J becomes index 9 in the array representation
    const SUMMARY_MAP = [
        { label: 'Available Wallet', rowIndex: 0, columnIndex: 9 },
        { label: 'Reseller Amount Due', rowIndex: 1, columnIndex: 9 },
        { label: 'Client Due', rowIndex: 2, columnIndex: 9 },
        { label: 'Total Amount Invested', rowIndex: 3, columnIndex: 9 }
    ];

    let transactions = [];

    // =====================================================
    // LOCAL STORAGE PERSISTENCE
    // =====================================================
    function loadTransactions() {
        try {
            transactions = JSON.parse(localStorage.getItem('transactions_v1') || '[]');
        } catch {
            transactions = [];
        }
    }

    function saveTransactions() {
        try {
            localStorage.setItem('transactions_v1', JSON.stringify(transactions));
        } catch {
            console.warn('Failed to save transactions to localStorage');
        }
    }

    // =====================================================
    // UTILITY FUNCTIONS
    // =====================================================
    function cleanNumber(v) {
        if (v == null) return NaN;
        const s = String(v).replace(/[₹,\s]/g, '');
        const n = parseFloat(s);
        return isNaN(n) ? NaN : n;
    }

    function normalizeKey(k) {
        return String(k || '').trim().toLowerCase();
    }

    function yellowRamp(t) {
        const a = { r: 255, g: 249, b: 196 };
        const b = { r: 255, g: 193, b: 7 };
        const r = Math.round(a.r + (b.r - a.r) * t);
        const g = Math.round(a.g + (b.g - a.g) * t);
        const bb = Math.round(a.b + (b.b - a.b) * t);
        return `rgb(${r},${g},${bb})`;
    }

    function greenRamp(t) {
        const a = { r: 200, g: 230, b: 201 };
        const b = { r: 46, g: 125, b: 50 };
        const r = Math.round(a.r + (b.r - a.r) * t);
        const g = Math.round(a.g + (b.g - a.g) * t);
        const bb = Math.round(a.b + (b.b - a.b) * t);
        return `rgb(${r},${g},${bb})`;
    }

    // =====================================================
    // TAB MANAGEMENT
    // =====================================================
    function switchTab(tab) {
        document.querySelectorAll('.section').forEach((sec) => sec.classList.remove('active'));
        document.getElementById(tab).classList.add('active');

        if (tab === 'view') fetchView();
        if (tab === 'profit') fetchMonthOptions();
        if (tab === 'investment') fetchInvestment();
    }

    // =====================================================
    // ADD EXPENSE FUNCTIONALITY
    // =====================================================
    function addTransaction() {
        const date = document.getElementById('date').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const note = document.getElementById('note').value;

        if (!date || isNaN(amount)) {
            alert('Enter valid date and amount');
            return;
        }

        transactions.push({ date, amount, note });
        saveTransactions();

        document.getElementById('date').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('note').value = '';

        populateMonthDropdown('view-month');
        alert('Transaction added.');
    }

    // =====================================================
    // VIEW EXPENSES FUNCTIONALITY
    // =====================================================
    function fetchView() {
        if (!document.getElementById('view-month').options.length) {
            populateMonthDropdown('view-month');
        }

        const selector = document.getElementById('view-month');
        const month = selector.value || '';
        const data = month
            ? transactions.filter((t) => t.date && t.date.startsWith(month))
            : transactions.slice();

        let total = 0;
        const table = document.getElementById('view-table');

        table.innerHTML =
            '<tr>' +
            '<th>Date</th>' +
            '<th>Amount</th>' +
            '<th>Note</th>' +
            '<th>Edit</th>' +
            '</tr>';

        data.forEach((t, i) => {
            total += Number(t.amount) || 0;

            table.innerHTML +=
                '<tr>' +
                '<td><input class="inline-input" type="date" value="' + (t.date || '') + '" onchange="updateTx(' + i + ', \'date\', this.value)" /></td>' +
                '<td><input class="inline-input" type="number" value="' + (t.amount ?? 0) + '" onchange="updateTx(' + i + ', \'amount\', parseFloat(this.value))" /></td>' +
                '<td><input class="inline-input" value="' + (t.note ? String(t.note).replace(/"/g, '&quot;') : '') + '" onchange="updateTx(' + i + ', \'note\', this.value)" /></td>' +
                '<td><button onclick="removeTx(' + i + ')">❌</button></td>' +
                '</tr>';
        });

        document.getElementById('total-expense').innerText = 'Total: ₹' + total.toFixed(2);
    }

    function updateTx(index, field, value) {
        transactions[index][field] = value;
        saveTransactions();
        fetchView();
    }

    function removeTx(index) {
        transactions.splice(index, 1);
        saveTransactions();
        fetchView();
    }

    function populateMonthDropdown(id) {
        const months = [...new Set(
            transactions.map((t) => (t.date || '').substring(0, 7)).filter(Boolean)
        )].sort();

        const sel = document.getElementById(id);
        sel.innerHTML = '';
        months.forEach((m) => {
            sel.innerHTML += '<option value="' + m + '">' + m + '</option>';
        });
        if (months.length) sel.value = months[months.length - 1];
    }

    // =====================================================
    // PROFIT FUNCTIONALITY
    // =====================================================
    async function fetchMonthOptions() {
        try {
            const res = await fetch(sheetURL + 'Profit%20Sheet');
            const data = await res.json();
            const months = [...new Set(data.map((r) => r.Month).filter(Boolean))];

            ['profit-month', 'view-month'].forEach((id) => {
                const sel = document.getElementById(id);
                sel.innerHTML = '';
                months.forEach((m) => {
                    sel.innerHTML += '<option value="' + m + '">' + m + '</option>';
                });
                if (months.length) sel.value = months[months.length - 1];
            });

            fetchProfit();
        } catch (e) {
            console.warn('Profit month options failed', e);
        }
    }

    async function fetchProfit() {
        try {
            const month = document.getElementById('profit-month').value;
            const res = await fetch(sheetURL + 'Profit%20Sheet');
            const data = await res.json();
            const row = data.find((r) => r.Month === month);
            const val = cleanNumber(row?.Profit);

            document.getElementById('profit-display').innerText = 'Profit: ₹' + ((isNaN(val) ? 0 : val).toFixed(2));
        } catch (e) {
            console.warn('Fetch profit failed', e);
            document.getElementById('profit-display').innerText = 'Profit: ₹0.00';
        }
    }

    // =====================================================
    // INVESTMENT FUNCTIONALITY
    // =====================================================
    async function fetchInvestment() {
        try {
            // Fetch Summary Data from specific cells (J2, J3, J4, J5)
            const resSummary = await fetch(sheetURL + summarySheetName);
            const summaryData = await resSummary.json();
            const summary = document.getElementById('investment-summary');
            summary.innerHTML = '';

            SUMMARY_MAP.forEach(item => {
                const row = summaryData[item.rowIndex] || {};
                // Access by column index (J = index 9 in OpenSheet array representation)
                const columnKeys = Object.keys(row);
                const value = cleanNumber(row[columnKeys[item.columnIndex]]);
                summary.innerHTML += '<li>' + item.label + ': ₹' + ((isNaN(value) ? 0 : value).toFixed(2)) + '</li>';
            });

            // Fetch Vendor Balances
            const res = await fetch(sheetURL + 'Vendor%20Sales%20Record');
            const data = await res.json();

            const vendorTable = document.getElementById('vendor-table');
            vendorTable.innerHTML =
                '<tr>' +
                '<th>Vendor Name</th>' +
                '<th>Balance</th>' +
                '</tr>';

            // Detect column keys
            const norm = s => String(s).trim().toLowerCase();
            const sample = data.find(r => {
                const ks = Object.keys(r).map(norm);
                return ks.includes('vendor name') && ks.includes('balance');
            });

            const vendorKey = sample
                ? Object.keys(sample).find(k => norm(k) === 'vendor name')
                : 'Vendor Name';

            const balanceKey = sample
                ? Object.keys(sample).find(k => norm(k) === 'balance')
                : 'Balance';

            // Collect vendor data
            const rows = [];
            let maxPos = 0;

            data.forEach(r => {
                const name = r[vendorKey];
                const bal = cleanNumber(r[balanceKey]);
                if (name && !isNaN(bal)) {
                    rows.push({ name, bal });
                    if (bal > 0) maxPos = Math.max(maxPos, bal);
                }
            });

            // Render with color coding
            rows.forEach(({ name, bal }) => {
                let style = '';
                let cls = '';

                if (bal < 0) {
                    style = 'background: var(--neg-bg); color: var(--neg-text); font-weight: 700;';
                    cls = 'neg';
                } else if (bal === 0) {
                    style = 'background:#fff; color:#222;';
                } else if (bal > 0 && bal < 5000) {
                    const t = Math.max(0, Math.min(1, bal / 5000));
                    const bg = yellowRamp(t);
                    style = 'background:' + bg + '; color:#222;';
                } else {
                    const denom = Math.max(1, (maxPos - 5000));
                    const t = Math.max(0, Math.min(1, (bal - 5000) / denom));
                    const bg = greenRamp(t);
                    style = 'background:' + bg + '; color:#fff;';
                }

                vendorTable.innerHTML +=
                    '<tr>' +
                    '<td>' + name + '</td>' +
                    '<td style="' + style + '" class="' + cls + '">₹' + bal.toFixed(2) + '</td>' +
                    '</tr>';
            });

        } catch (e) {
            console.warn('Fetch investment failed', e);
            document.getElementById('investment-summary').innerHTML = '<li>Unable to load investment summary.</li>';
            document.getElementById('vendor-table').innerHTML = '<tr><td colspan="2">Unable to load vendor balances.</td></tr>';
        }
    }

    // =====================================================
    // INITIALIZATION
    // =====================================================
    (function init() {
        loadTransactions();
        populateMonthDropdown('view-month');
    })();
</script>
</body> </html>

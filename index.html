<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" />
<title>Daily Expenses Tracker üéÄ</title>
<style>
    :root {
        --brand: #e91e63;
        --btn: #f8bbd0;
        --btn-hover: #f48fb1;
        --card-bg: rgba(255, 255, 255, 0.88);
        --border: #ccc;
        --text: #222;
        --table-header: #fafafa;
        --neg-text: #8b0000;
        --neg-bg: #ffe5e5;
    }
    body {
        margin: 0;
        font-family: 'Quicksand', sans-serif;
        color: var(--text);
        background: url('https://i.pinimg.com/736x/58/09/12/5809128d95aee17fdad43073ef5495be.jpg') no-repeat center center fixed;
        background-size: cover;
    }
    .app {
        max-width: 900px;
        margin: 40px auto 60px;
        background: var(--card-bg);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }
    h1 { text-align: center; color: var(--brand); margin: 6px 0 16px; }
    nav { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 18px; }
    nav button {
        background-color: var(--btn);
        border: none; padding: 10px 18px; border-radius: 20px;
        font-weight: 700; cursor: pointer; transition: 0.2s ease;
    }
    nav button:hover { background-color: var(--btn-hover); transform: translateY(-1px); }
    .section { display: none; }
    .section.active { display: block; }
    .field { margin: 10px 0; }
    .field label { display: block; margin-bottom: 6px; font-weight: 600; }
    input, select, textarea {
        width: 70%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); font-family: inherit;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; border: 1px solid var(--border); text-align: center; background: #fff; }
    th { background: var(--table-header); }
    .inline-input { border: none; background: transparent; width: 90%; }
    .muted { color: #666; }
    .neg { color: var(--neg-text); font-weight: 700; }
</style>
</head>
<body>
<div class="app">
    <h1>Daily Expenses Tracker üéÄ</h1>

    <nav>
        <button onclick="switchTab('add')">‚ûï Add</button>
        <button onclick="switchTab('view')">üìä View</button>
        <button onclick="switchTab('profit')">üí∞ Profit</button>
        <button onclick="switchTab('investment')">üìà Investment</button>
    </nav>

    <!-- Add -->
    <div id="add" class="section active">
        <div class="field">
            <label for="date">Date</label>
            <input type="date" id="date" />
        </div>
        <div class="field">
            <label for="amount">Expense Amount</label>
            <input type="number" id="amount" />
        </div>
        <div class="field">
            <label for="note">Comments</label>
            <textarea id="note"></textarea>
        </div>
        <button onclick="addTransaction()">Save</button>
        <p class="muted">Entries are saved online to your Google Sheet.</p>
    </div>

    <!-- View -->
    <div id="view" class="section">
        <div class="field">
            <label for="view-month">Month & Year</label>
            <select id="view-month" onchange="renderView()"></select>
        </div>
        <h3 id="total-expense">Total: ‚Çπ0</h3>
        <table id="view-table"></table>
    </div>

    <!-- Profit -->
    <div id="profit" class="section">
        <div class="field">
            <label for="profit-month">Month & Year</label>
            <select id="profit-month" onchange="fetchProfit()"></select>
        </div>
        <h3 id="profit-display">Profit: ‚Çπ0</h3>
    </div>

    <!-- Investment -->
    <div id="investment" class="section">
        <h3>Summary</h3>
        <ul id="investment-summary"></ul>

        <h3>Vendor Balances</h3>
        <table id="vendor-table"></table>

        <p class="muted">
            Color scale: negative = red. 0‚Äì4,999 uses yellow gradient (toward 5,000). ‚â•5,000 uses green gradient (deepest green is the highest).
        </p>
    </div>
</div>

<script>
    // =========================
    // CONFIG
    // =========================
    const opensheetBase = 'https://opensheet.elk.sh/1UMul8nt25GR8MUM-_EdwAR0q6Ne2ovPv_R-m1-CHeXw/';
    const profitSheetName = 'Profit%20Sheet';
    const vendorSheetName  = 'Vendor%20Sales%20Record';

    // >>> REPLACE THIS with your Apps Script Web App URL <<<
    const apiURL = 'YOUR_APPS_SCRIPT_WEB_APP_URL';

    // For Investment summary fixed cells (J2..J5 -> index 9)
    const SUMMARY_MAP = [
        { label: 'Available Wallet',       rowIndex: 0, columnIndex: 9 },
        { label: 'Reseller Amount Due',    rowIndex: 1, columnIndex: 9 },
        { label: 'Client Due',             rowIndex: 2, columnIndex: 9 },
        { label: 'Total Amount Invested',  rowIndex: 3, columnIndex: 9 }
    ];

    // =========================
    // HELPERS
    // =========================
    function cleanNumber(v){ if(v==null) return NaN; const s=String(v).replace(/[‚Çπ,\s]/g,''); const n=parseFloat(s); return isNaN(n)?NaN:n; }
    function yellowRamp(t){const a={r:255,g:249,b:196},b={r:255,g:193,b:7};const r=Math.round(a.r+(b.r-a.r)*t),g=Math.round(a.g+(b.g-a.g)*t),bb=Math.round(a.b+(b.b-a.b)*t);return `rgb(${r},${g},${bb})`;}
    function greenRamp(t){const a={r:200,g:230,b:201},b={r:46,g:125,b:50};const r=Math.round(a.r+(b.r-a.r)*t),g=Math.round(a.g+(b.g-a.g)*t),bb=Math.round(a.b+(b.b-a.b)*t);return `rgb(${r},${g},${bb})`;}

    // =========================
    // TABS
    // =========================
    function switchTab(tab){
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        if(tab==='view') initView();
        if(tab==='profit') fetchMonthOptions();
        if(tab==='investment') fetchInvestment();
    }

    // =========================
    // TRANSACTIONS (Google Apps Script backend)
    // =========================
    async function addTransaction(){
        const date = document.getElementById('date').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const note = document.getElementById('note').value;

        if(!apiURL || apiURL.includes('YOUR_APPS_SCRIPT_WEB_APP_URL')){
            alert('Please set your Apps Script Web App URL in the code (apiURL).');
            return;
        }
        if(!date || isNaN(amount)){ alert('Enter valid date and amount'); return; }

        await fetch(apiURL, {
          method: 'POST',
          body: JSON.stringify({ action: 'add', date, amount, note })
        });

        document.getElementById('date').value = '';
        document.getElementById('amount').value = '';
        document.getElementById('note').value = '';

        await initView(); // refresh view dropdowns & list
        alert('Transaction saved online.');
    }

    async function fetchTransactions(){
        if(!apiURL || apiURL.includes('YOUR_APPS_SCRIPT_WEB_APP_URL')) return [];
        const res = await fetch(apiURL, { cache: 'no-store' });
        const data = await res.json();
        // Ensure strings for date (YYYY-MM-DD) coming from sheet
        return data.map(r => ({
            row: r.row,
            date: (typeof r.date === 'string') ? r.date : (r.date && r.date.toString ? r.date.toString() : ''),
            amount: Number(r.amount) || 0,
            note: r.note || ''
        }));
    }

    async function updateTransaction(row, col, value){
        await fetch(apiURL, {
          method: 'POST',
          body: JSON.stringify({ action: 'update', row, col, value })
        });
    }

    async function deleteTransaction(row){
        await fetch(apiURL, {
          method: 'POST',
          body: JSON.stringify({ action: 'delete', row })
        });
    }

    // =========================
    // VIEW RENDER
    // =========================
    let cachedTx = [];
    async function initView(){
        cachedTx = await fetchTransactions();
        populateViewMonths(cachedTx);
        renderView();
    }

    function populateViewMonths(list){
        const months = [...new Set(
            list.map(t => (t.date||'').substring(0,7)).filter(Boolean)
        )].sort();
        const sel = document.getElementById('view-month');
        sel.innerHTML = '';
        months.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
        if(months.length) sel.value = months[months.length-1];
    }

    function renderView(){
        const sel = document.getElementById('view-month');
        const month = sel.value || '';
        const rows = cachedTx.filter(t => t.date && t.date.startsWith(month));

        let total = 0;
        const table = document.getElementById('view-table');
        table.innerHTML = `
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Note</th>
            <th>Delete</th>
          </tr>`;

        rows.forEach((t) => {
            total += (Number(t.amount)||0);
            // Use data-row & data-col to know which cell to update
            table.innerHTML += `
              <tr>
                <td><input class="inline-input" type="date" value="${t.date}" data-row="${t.row}" data-col="0" onchange="onCellEdit(this)" /></td>
                <td><input class="inline-input" type="number" value="${t.amount}" data-row="${t.row}" data-col="1" onchange="onCellEdit(this)" /></td>
                <td><input class="inline-input" value="${(t.note||'').replace(/"/g,'&quot;')}" data-row="${t.row}" data-col="2" onchange="onCellEdit(this)" /></td>
                <td><button onclick="onDelete(${t.row})">‚ùå</button></td>
              </tr>`;
        });

        document.getElementById('total-expense').innerText = 'Total: ‚Çπ' + total.toFixed(2);
    }

    async function onCellEdit(input){
        const row = Number(input.getAttribute('data-row'));
        const col = Number(input.getAttribute('data-col'));
        const value = (col===1) ? parseFloat(input.value||'0') : input.value;
        if (col===1 && isNaN(value)) { alert('Enter a valid number'); return; }
        await updateTransaction(row, col, value);
        // Refresh cache and UI
        cachedTx = await fetchTransactions();
        renderView();
    }

    async function onDelete(row){
        if(!confirm('Delete this entry?')) return;
        await deleteTransaction(row);
        cachedTx = await fetchTransactions();
        renderView();
    }

    // =========================
    // PROFIT (OpenSheet - read-only)
    // =========================
    async function fetchMonthOptions(){
        try{
            const res = await fetch(opensheetBase + profitSheetName, { cache: 'no-store' });
            const data = await res.json();
            const months = [...new Set(data.map(r => r.Month).filter(Boolean))];
            const sel = document.getElementById('profit-month');
            sel.innerHTML = '';
            months.forEach(m => sel.innerHTML += `<option value="${m}">${m}</option>`);
            if(months.length) sel.value = months[months.length-1];
            fetchProfit();
        }catch(e){
            console.warn('Profit month options failed', e);
        }
    }

    async function fetchProfit(){
        try{
            const month = document.getElementById('profit-month').value;
            const res = await fetch(opensheetBase + profitSheetName, { cache: 'no-store' });
            const data = await res.json();
            const row = data.find(r => r.Month === month);
            const val = cleanNumber(row?.Profit);
            document.getElementById('profit-display').innerText = 'Profit: ‚Çπ' + ((isNaN(val)?0:val).toFixed(2));
        }catch(e){
            console.warn('Fetch profit failed', e);
            document.getElementById('profit-display').innerText = 'Profit: ‚Çπ0.00';
        }
    }

    // =========================
    // INVESTMENT (OpenSheet - read-only)
    // =========================
    async function fetchInvestment(){
        try{
            // Summary: J2..J5 via column index 9
            const resSummary = await fetch(opensheetBase + vendorSheetName, { cache: 'no-store' });
            const summaryData = await resSummary.json();
            const summary = document.getElementById('investment-summary');
            summary.innerHTML = '';
            SUMMARY_MAP.forEach(item => {
                const rowObj = summaryData[item.rowIndex] || {};
                const keys = Object.keys(rowObj);
                const val = cleanNumber(rowObj[keys[item.columnIndex]]);
                summary.innerHTML += `<li>${item.label}: ‚Çπ${(isNaN(val)?0:val).toFixed(2)}</li>`;
            });

            // Vendor balances from Column B (index 1) & Column F (index 5)
            const data = summaryData; // same fetch covers it
            const vendorTable = document.getElementById('vendor-table');
            vendorTable.innerHTML = `
              <tr>
                <th>Vendor Name</th>
                <th>Balance</th>
              </tr>`;

            const rows = [];
            let maxPos = 0;

            for (let i = 5; i < data.length; i++){
                const r = data[i] || {};
                const keys = Object.keys(r);
                const name = r[keys[1]];        // Column B
                const bal  = cleanNumber(r[keys[5]]); // Column F
                if (name && !isNaN(bal) && bal !== 0){
                    rows.push({ name, bal });
                    if (bal > 0) maxPos = Math.max(maxPos, bal);
                }
            }

            rows.forEach(({name, bal}) => {
                let style='', cls='';
                if (bal < 0){
                    style = 'background: var(--neg-bg); color: var(--neg-text); font-weight:700;';
                    cls = 'neg';
                } else if (bal > 0 && bal < 5000){
                    const t = Math.max(0, Math.min(1, bal/5000));
                    style = 'background:'+yellowRamp(t)+'; color:#222;';
                } else if (bal >= 5000){
                    const denom = Math.max(1, (maxPos - 5000));
                    const t = Math.max(0, Math.min(1, (bal - 5000) / denom));
                    style = 'background:'+greenRamp(t)+'; color:#fff;';
                }
                vendorTable.innerHTML += `
                  <tr>
                    <td>${name}</td>
                    <td style="${style}" class="${cls}">‚Çπ${bal.toFixed(2)}</td>
                  </tr>`;
            });

        }catch(e){
            console.warn('Fetch investment failed', e);
            document.getElementById('investment-summary').innerHTML = '<li>Unable to load investment summary.</li>';
            document.getElementById('vendor-table').innerHTML = '<tr><td colspan="2">Unable to load vendor balances.</td></tr>';
        }
    }

    // =========================
    // INIT
    // =========================
    (async function init(){
        // Default to Add tab visible; others load on demand
        // Optionally prefetch Profit months to make it snappy on first open:
        // fetchMonthOptions();
    })();
</script>
</body>
</html>
